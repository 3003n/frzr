#! /bin/bash

if [ $EUID -ne 0 ]; then
	echo "$(basename $0) must be run as root"
	exit 1
fi

# Check device ID and see if any quirks exist
if [ -e "${MOUNT_PATH}"/etc/device-quirks/id-device ]; then
   "${MOUNT_PATH}"/etc/device-quirks/./id-device
   RESULT=$?
else
   echo "Unable to run id-device to determine if quirks need to be applied"
   exit 0
fi
   
if [ -d /tmp/frzr_root ]; then
    # Find the latest deployment directory
    DEPLOYMENT_DIR=$(ls -d /tmp/frzr_root/deployments/chimeraos*/)

    if [ -d "$DEPLOYMENT_DIR" ]; then
    
        cd /tmp/frzr_root/deployments/chimeraos*/
        # Mount necessary file systems
        mount -t proc /proc proc/
        mount -t sysfs /sys sys/
        mount --rbind /dev dev/
        
        # Set R/W permissions
        btrfs property set -fts ${DEPLOYMENT_DIR} ro false
        chroot /tmp/frzr_root/deployments/chimeraos*/ /bin/bash <<EOF
        # Commands to be ran in chroot
        cp /boot/chimeraos*/vmlinuz* /boot/vmlinuz-linux-lts
        mkinitcpio -P
        cp /boot/initramfs-linux-lts.img /boot/chimeraos*/initramfs-linux.img
EOF
	# Set back to R/O permissions
	btrfs property set -fts ${DEPLOYMENT_DIR} ro true
    else
        echo "No deployment directory found in /tmp/frzr_root"
        exit 1
    fi
    exit 0
else
    echo "We don't appear to be running from an arch install media"
fi
   # Build initramfs from within a deployed system
   if [ -d /frzr_root ]; then
      # Set R/W permissions
      btrfs property set -fts /frzr_root/deployments/chimeraos*/ ro false
      cp /boot/chimeraos*/vmlinuz* /boot/vmlinuz-linux-lts
      mkinitcpio -P
      cp /boot/initramfs-linux-lts.img /boot/chimeraos*/initramfs-linux.img
      # Set R/O permissions
      btrfs property set -fts /frzr_root/deployments/chimeraos*/ ro true
   fi
else
   echo "initramfs did not need to be rebuilt"
fi
