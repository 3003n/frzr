#! /bin/bash

if [ $EUID -ne 0 ]; then
	echo "$(basename $0) must be run as root"
	exit 1
fi

# If the script is being ran directly we will need to set the paths
if [ -d /tmp/frzr_root ]; then
	export MOUNT_PATH=$1
	export SUBVOL=$2
	export NAME=$3
else
# This is for running frzr-initramfs from the deployed system itself without frzr-deploy
	export MOUNT_PATH=""
	export SUBVOL=""
	export NAME=/frzr_root/deployments/chimeraos*/ # Temporary solution
fi

# Checking paths
echo "Checking installion info..."
echo "Root Mount:${MOUNT_PATH}"
echo "Subvolume Mount:${SUBVOL}"
echo "Deployment Name:${NAME}"

# Check device ID and see if any quirks exist in the new image being deployed
if [ -e ${SUBVOL}/usr/share/device-quirks/id-device ]; then
        ${SUBVOL}/usr/share/device-quirks/id-device
        RESULT=$?
# If we don't see what were looking for in the new image, then check the current system as the last resort
elif [ -e "/etc/device-quirks/id-device" ]; then
        /etc/device-quirks/id-device
        RESULT=$?
# This will happen if the device quirks package is not installed, exit gracefully
else
   echo "Unable to run id-device to determine if quirks need to be applied"
   exit 0
fi

if [ ${RESULT} == "0" ]; then

	echo "We received the signal to rebuild the initramfs"
	if [ -d /tmp/frzr_root ]; then

	    if [ -d "${SUBVOL}" ]; then
	    
		cd ${SUBVOL}
		# Mount necessary file systems
		mount -t proc /proc proc/
		mount -t sysfs /sys sys/
		mount --rbind /dev dev/
		
		# Set R/W permissions
		btrfs property set -fts ${SUBVOL} ro false
		chroot ${SUBVOL} /bin/bash <<EOF
		# Commands to be ran in chroot
		cp ${MOUNT_PATH}/boot/chimeraos*/vmlinuz* ${MOUNT_PATH}/boot/vmlinuz-linux-lts
		mkinitcpio -P
		cp ${MOUNT_PATH}/boot/initramfs-linux-lts.img ${MOUNT_PATH}/boot/chimeraos*/initramfs-linux.img
EOF
		# Set back to R/O permissions
		btrfs property set -fts ${SUBVOL} ro true
	    else
		echo "No deployment directory found in /tmp/frzr_root"
		exit 1
	    fi
	    exit 0
	else
	    echo "We don't appear to be running from an arch install media"
	fi
	   # Build initramfs from within a deployed system
	if [ -d /frzr_root ]; then
	      # Set R/W permissions
	      btrfs property set -fts ${SUBVOL} ro false
	      cp ${MOUNT_PATH}/boot/chimeraos*/vmlinuz* ${MOUNT_PATH}/boot/vmlinuz-linux-lts
	      mkinitcpio -P
	      cp ${MOUNT_PATH}/boot/initramfs-linux-lts.img ${MOUNT_PATH}/boot/chimeraos*/initramfs-linux.img
	      # Set R/O permissions
	      btrfs property set -fts ${SUBVOL} ro true
	fi
else
   echo "initramfs did not need to be rebuilt"
fi
